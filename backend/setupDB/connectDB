const { MongoClient, ServerApiVersion } = require('mongodb');
const uri="mongodb+srv://userAdmin:motdepasse@mentoringdb.g9iol.mongodb.net/?retryWrites=true&w=majority&appName=MentoringDB"
const client = new MongoClient(uri);
const bcrypt = require('bcrypt'); 



async function addNewUserInDB(name, desc, email, num, isAdmin, password){
    const db = client.db("users");
    const collection = db.collection("users");
    let creationDate= new Date();
    let idUser=0;
    //on récupère le dernier idUser
    const lastUser = await collection.find({}).sort({idUser:-1}).limit(1).toArray();

    //hash password
    const hashedPassword = bcrypt.hashSync(password, 10);

    //on récupère le dernier idUser et on l'incrémente
    if(lastUser.length>0){
        idUser=lastUser[0].UserID+1;
    }
    let emptyArray=[];
    const result = await collection.insertOne({name: name, description: desc, email: email, num: num, isAdmin: isAdmin, UserID: idUser, creationDate: creationDate, PostsIDs: emptyArray, ListConvID:emptyArray, Password: hashedPassword});
    console.log("Nouvel utilisateur ajouté dans la base de données :", result);
}

async function checkAllUsernamesInDB(){
    const db = client.db("users");
    const collection = db.collection("users");
    const result = await collection.find({}).toArray();
    console.log("Liste des utilisateurs dans la base de données :", result);
}

addNewUserInDB("machin", "bidule", "caca@gmail.com", "0601020304", false, "mypassword");
checkAllUsernamesInDB();